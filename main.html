<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Murray Osorio Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f6f8fa;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    
    #app-container {
      display: flex;
      height: 90vh;
      max-width: 1000px;
      width: 100%;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      overflow: hidden;
    }
    
    /* Sidebar */
    #sidebar {
      width: 250px;
      background: #2c2c2c;
      color: white;
      display: flex;
      flex-direction: column;
    }
    
    #sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #444;
    }
    
    #new-chat-btn {
      width: 100%;
      padding: 12px;
      background: #4a9eff;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    #new-chat-btn:hover {
      background: #3a8eef;
    }
    
    #conversations {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    
    .conversation-item {
      padding: 12px;
      margin-bottom: 8px;
      background: #3a3a3a;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: background 0.2s;
    }
    
    .conversation-item:hover {
      background: #4a4a4a;
    }
    
    .conversation-item.active {
      background: #4a9eff;
    }
    
    .conversation-preview {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .conversation-time {
      font-size: 0.7rem;
      color: #aaa;
      margin-top: 4px;
    }
    
    /* Chat area */
    #custom-wrapper {
      flex: 1;
      background: white;
      padding: 20px;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      position: relative;
    }
    
    #n8n-chat {
      flex: 1;
      overflow: hidden;
    }
    
    /* n8n overrides */
    :root {
      --chat--window--width: 100%;
      --chat--window--height: 100%;
      --chat--message--padding: 12px;
      --chat--message--font-size: 0.7rem;
    }
    
    .n8n-chat__window {
      max-height: 100% !important;
      overflow: hidden;
    }
    
    .n8n-chat__messages {
      height: 100%;
      overflow-y: auto !important;
    }
    
    /* Disclaimer styling */
    .ai-disclaimer {
      font-size: 0.65rem;
      line-height: 1.4;
      color: #666;
      margin-top: 12px;
      text-align: left;
    }
    
    /* Loading state */
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
  </style>
</head>
<body>
  <div id="app-container">
    <!-- Sidebar -->
    <div id="sidebar">
      <div id="sidebar-header">
        <button id="new-chat-btn">+ New Chat</button>
      </div>
      <div id="conversations">
        <div class="loading">Loading conversations...</div>
      </div>
    </div>
    
    <!-- Chat area -->
    <div id="custom-wrapper">
      <div id="n8n-chat"></div>
      <p class="ai-disclaimer">
        Disclaimer: This content may include AI-generated material. While efforts have been made to ensure accuracy, please independently verify important details and seek professional advice when necessary.
      </p>
    </div>
  </div>
  
  <script type="module">
    import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';
    
    const CHAT_WEBHOOK = 'https://murrayosorio.app.n8n.cloud/webhook/836d255b-452d-410b-9e47-94e3f85afde7/chat';
    const CONVERSATIONS_WEBHOOK = 'YOUR_CONVERSATIONS_WEBHOOK_URL'; // Add this
    const HISTORY_WEBHOOK = 'YOUR_HISTORY_WEBHOOK_URL'; // Add this
    
    let currentSession = null;
    let chatInstance = null;
    
    // Format time
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 86400000) return 'Today';
      if (diff < 172800000) return 'Yesterday';
      return date.toLocaleDateString();
    }
    
    // Load all conversations
    async function loadConversations() {
      try {
        const response = await fetch(CONVERSATIONS_WEBHOOK);
        const data = await response.json();
        
        const container = document.getElementById('conversations');
        container.innerHTML = '';
        
        if (!data.conversations || data.conversations.length === 0) {
          container.innerHTML = '<div class="loading">No conversations yet</div>';
          return;
        }
        
        data.conversations.forEach(conv => {
          const div = document.createElement('div');
          div.className = 'conversation-item';
          if (conv.sessionId === currentSession) {
            div.classList.add('active');
          }
          
          div.innerHTML = `
            <div class="conversation-preview">${conv.preview || 'New conversation'}</div>
            <div class="conversation-time">${formatTime(conv.timestamp)}</div>
          `;
          
          div.onclick = () => loadChat(conv.sessionId);
          container.appendChild(div);
        });
      } catch (error) {
        console.error('Failed to load conversations:', error);
        document.getElementById('conversations').innerHTML = '<div class="loading">Failed to load</div>';
      }
    }
    
    // Load chat history
    async function loadChatHistory(sessionId) {
      try {
        const response = await fetch(HISTORY_WEBHOOK, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId })
        });
        const data = await response.json();
        return data.messages || [];
      } catch (error) {
        console.error('Failed to load history:', error);
        return [];
      }
    }
    
    // Initialize chat widget
    async function initChat(sessionId = null, messages = []) {
      // Clear existing chat
      const chatContainer = document.getElementById('n8n-chat');
      chatContainer.innerHTML = '';
      
      currentSession = sessionId || `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      
      // Create chat with history
      chatInstance = createChat({
        webhookUrl: CHAT_WEBHOOK,
        mode: 'fullscreen',
        allowFileUploads: true,
        target: '#n8n-chat',
        initialMessages: [
          'What can I translate for you today?',
          ...messages
        ],
        webhookConfig: {
          headers: {
            'X-Session-ID': currentSession
          }
        },
        i18n: {
          en: {
            title: 'AI Translator',
            subtitle: '',
            inputPlaceholder: 'Type your question...',
          },
        },
        onInit: () => {
          const style = document.createElement('style');
          style.textContent = `
            .n8n-chat__header {
              background-color: transparent !important;
              box-shadow: none !important;
            }
            .n8n-chat__logo,
            .n8n-chat__logo img {
              background-color: transparent !important;
            }
            .n8n-chat, .n8n-chat * {
              font-size: 12px !important;
            }
          `;
          document.head.appendChild(style);
        },
      });
      
      // Update sidebar
      updateSidebarActive();
    }
    
    // Load specific chat
    async function loadChat(sessionId) {
      const messages = await loadChatHistory(sessionId);
      await initChat(sessionId, messages);
      await loadConversations(); // Refresh sidebar
    }
    
    // Update active conversation in sidebar
    function updateSidebarActive() {
      document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
      });
      
      const items = document.querySelectorAll('.conversation-item');
      items.forEach(item => {
        const preview = item.querySelector('.conversation-preview').textContent;
        // This is a simplified check, you might need better logic
        if (currentSession) {
          item.classList.add('active');
        }
      });
    }
    
    // New chat button
    document.getElementById('new-chat-btn').onclick = async () => {
      await initChat();
      await loadConversations();
    };
    
    // Initial load
    (async () => {
      await loadConversations();
      await initChat(); // Start with new chat
    })();
  </script>
</body>
</html>
